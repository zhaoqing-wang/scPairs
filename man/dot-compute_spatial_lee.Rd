% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/spatial_adjacency.R
\name{.compute_spatial_lee}
\alias{.compute_spatial_lee}
\title{Compute bivariate spatial autocorrelation (Lee's L) for gene pairs}
\usage{
.compute_spatial_lee(coords, mat, pair_dt, k = 6, n_perm = 199, verbose = TRUE)
}
\arguments{
\item{coords}{Data.frame with columns \code{x}, \code{y} and rownames = cell barcodes.}

\item{mat}{Expression matrix (genes x cells).}

\item{pair_dt}{\code{data.table} with columns \code{gene1}, \code{gene2}.}

\item{k}{Integer; number of spatial nearest neighbours (default 6 for
Visium hexagonal grids; 15 for general ST).}

\item{n_perm}{Integer; number of permutations for empirical p-values.
Set to 0 to skip.}

\item{verbose}{Logical.}
}
\value{
The input \code{pair_dt} with added columns \code{spatial_lee_L} and
optionally \code{spatial_lee_p}.
}
\description{
Lee's L statistic (Lee, 2001) generalises Moran's I to the bivariate case,
measuring spatial co-variation of two variables simultaneously.  A positive L
means that nearby locations tend to have similar \emph{joint} expression patterns;
a negative L indicates spatial segregation.
}
\details{
For efficiency, a k-nearest-neighbour spatial weights matrix is used rather
than a full distance matrix.

\strong{Performance (v0.1.1):} The spatial lag is computed via sparse matrix
multiplication (\code{W \%*\% t(mat)}) for all genes at once, replacing the
previous per-pair R-level loop.  Lee's L for all pairs is then computed via
vectorised column inner products.  Permutation testing is similarly
vectorised: the entire gene expression matrix is permuted and all pairs
evaluated per permutation.

\strong{Lee's L statistic} is defined as:
\deqn{L(x,y) = \frac{n}{S_0} \cdot \frac{(Wx)^\top (Wy)}{(\sum x_i^2)^{1/2} (\sum y_i^2)^{1/2}}}
where W is a row-standardised spatial weight matrix and S_0 = n (under
row-standardisation).  The statistic ranges from -1 to 1.
}
\references{
Lee, S.-I. (2001). Developing a bivariate spatial association measure: An
integration of Pearson's r and Moran's I. \emph{Journal of Geographical Systems},
3(4), 369-385.
}
\keyword{internal}
